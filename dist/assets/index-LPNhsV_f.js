(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();class y{constructor(){console.log("new game"),this.grid=new Map([[[],[],[],[]],[[],[],[],[]],[[],[],[],[]],[[],[],[],[]]]),this.moved=!1,this.score=0,this.update_score(),this.update_max_score(),this.game_html=document.getElementById("grid"),this.addTile(this.randomEmptyPosition(),this.randomValue()),this.addTile(this.randomEmptyPosition(),this.randomValue())}randomValue(){return Math.random()<.9?2:4}randomEmptyPosition(){var e=this.emptyPositions();return e[Math.floor(Math.random()*e.length)]}emptyPositions(){var e=[];for(let t=0;t<4;t++)for(let o=0;o<4;o++)this.grid.get(new Position(o,t)).length===0&&e.push(new Position(o,t));return e}addTile(e,t){console.log("add tile "+e+", value "+t);var o=this.createTile(t);return this.grid.set(e,[o]),this.setTilePosition(o,e),o}createTile(e){var t=document.createElement("div");return t.classList.add("tile"),t.classList.add("tile-"+e),t.innerHTML=e,this.game_html.appendChild(t),t}setTilePosition(e,t){console.log("update position "+t),e.className=e.className.replace(/position-.*/,""),e.classList.add("position-"+t.x+"-"+t.y)}setTileValue(e,t){return console.log("update value "+t),e.className=e.className.replace(/title-.*/,""),e.classList.add("tile-"+t),e.innerHTML=t,e}move(e){this.moved=!0;const t={"1,0":{start:[3,0],end:[-1,4],step:[-1,1]},"-1,0":{start:[0,0],end:[4,4],step:[1,1]},"0,1":{start:[0,3],end:[4,-1],step:[1,-1]},"0,-1":{start:[0,0],end:[4,4],step:[1,1]}},o=`${e.x},${e.y}`,{start:i,end:s,step:n}=t[o];for(let h=i[1];h!==s[1];h+=n[1])for(let f=i[0];f!==s[0];f+=n[0]){let l=new Position(f,h),u=this.grid.get(l).shift();if(!u)continue;var c=u.innerHTML;let d=new Position(l.x+e.x,l.y+e.y);for(;d.inMap(this.grid)&&this.grid.get(d).length<2&&(this.grid.get(d).length===0||this.grid.get(d)[0]?.innerHTML==c);)l=d,d=new Position(l.x+e.x,l.y+e.y);console.log("current_position "+l),console.log(this.grid),this.grid[l.y][l.x].push(u),this.setTilePosition(u,l)}}fusion(){for(let t=0;t<4;t++)for(let o=0;o<4;o++){let i=new Position(o,t),s=this.grid.get(i);if(s.length>1){let n=parseInt(s[0].innerHTML)*2;this.score+=n;for(var e of s)e.remove();this.addTile(i,n)}}this.update_score(),this.update_max_score()}create_random_tile(){if(this.moved!=!1){var e=this.addTile(this.randomEmptyPosition(),this.randomValue());this.moved=!1,console.log("create random tile "+e)}}update_score(){document.getElementById("score_value").innerHTML=this.score}update_max_score(){var e=localStorage.getItem("better_score");e===null&&(e=0),e<this.score&&(localStorage.setItem("better_score",this.score),e=this.score),document.getElementById("better_score_value").innerHTML=e}end_game(){for(let o=0;o<4;o++)for(let i=0;i<4;i++){let s=new Position(i,o);if(this.grid.get(s).length===0)return!1;let n=this.grid.get(s)[0],c=parseInt(n.innerHTML);for(var e of[-1,1]){var t=new Position(i+e,o);if(t.inMap(this.grid)!=!1&&(this.grid.get(t).length===0||c==parseInt(this.grid.get(t)[0].innerHTML)))return!1}for(var e of[-1,1]){var t=new Position(i,o+e);if(t.inMap(this.grid)!=!1&&(this.grid.get(t).length===0||c==parseInt(this.grid.get(t)[0].innerHTML)))return!1}}return!0}}var m=!1;document.addEventListener("transitionend",r=>{console.log(`Transition terminée sur ${r.target.tagName}`),m=!1,a.fusion(),a.create_random_tile(),a.end_game()&&(console.log("end game"),document.getElementById("game-over").style.display="block")});document.addEventListener("transitionstart",r=>{r.propertyName==="transform"&&(console.log(`Une transition sur ${r.propertyName} a commencé sur`,r.target),m=!0)});const v=document.querySelector("#restart");v.addEventListener("click",()=>{window.location.reload()});var a=new y;document.addEventListener("keydown",r=>{if(m)return;switch(r.key){case"ArrowUp":a.move(new Position(0,-1));break;case"ArrowDown":a.move(new Position(0,1));break;case"ArrowLeft":a.move(new Position(-1,0));break;case"ArrowRight":a.move(new Position(1,0));break}},!1);let g=0,p=0;document.addEventListener("touchstart",function(r){r.touches.length===1&&(g=r.touches[0].clientX,p=r.touches[0].clientY)},!1);document.addEventListener("touchend",function(r){if(!m&&r.changedTouches.length===1){let e=r.changedTouches[0].clientX-g,t=r.changedTouches[0].clientY-p;Math.abs(e)>Math.abs(t)?e>30?a.move(new Position(1,0)):e<-30&&a.move(new Position(-1,0)):t>30?a.move(new Position(0,1)):t<-30&&a.move(new Position(0,-1))}},!1);
